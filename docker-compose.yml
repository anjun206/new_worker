services:
  worker:
    container_name: dubbing-worker
    platform: ${DOCKER_PLATFORM:-linux/arm64/v8} # M1 Mac 환경 대응
    build:
      context: ./app
      dockerfile: Dockerfile
      target: runtime
    image: dubbing-worker:latest
    ports:
      - "8000:8000"
    volumes:
      - ./app:/app
      - ./data:/data
      - ./models:/models
    env_file:
      - .env
    environment:
      - UVICORN_RELOAD=${UVICORN_RELOAD---reload}
      - DATA_DIR=/data
      - INPUTS_DIR=/data/inputs
      - INTERIM_DIR=/data/interim
      - OUTPUTS_DIR=/data/outputs
      - MODELS_DIR=/models
      - WHISPERX_CACHE_DIR=/models/.cache/whisperx
      - XDG_CACHE_HOME=/models/.cache
      - CUDA_HOME=${CUDA_HOME-/usr/local/cuda}
      # 컨테이너 내부 기본값으로 PYTHONPATH 지정 (호스트에 같은 이름 env가 있으면 그 값을 사용)
      - PYTHONPATH=${PYTHONPATH-/opt/CosyVoice:/opt/CosyVoice/third_party/Matcha-TTS}
    # gpus: all # mac 환경에서는 주석 처리
    restart: unless-stopped
